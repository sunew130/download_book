name: Download and Convert Book

on:
  workflow_dispatch:
    inputs:
      title:
        description: 'Book title'
        required: true

jobs:
  process-book:
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: /workdir/downloads
    steps:
    - uses: actions/checkout@v4
    
    # æ–°å¢ï¼šåˆ›å»ºå¸¦æ—¶é—´æˆ³çš„ä¸‹è½½ç›®å½•
    - name: Create timestamp directory
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "OUTPUT_PATH=$OUTPUT_DIR/${TIMESTAMP}_${{ github.event.inputs.title }}" >> $GITHUB_ENV

    # Calibre å®¹å™¨ä¼˜åŒ–ç‰ˆ
    - name: Run Calibre container
      run: | 
            docker run --rm -v $(pwd):/workdir linuxserver/calibre:latest /bin/bash -c " \
              apt-get update && echo 'Update done' && \
              apt-get install -y python3-pip git xvfb && echo 'Install done' && \
              python3 -m pip install requests --break-system-packages && echo 'Pip done' && \
              python3 -m pip install git+https://github.com/sunew130/Zlibrary-API.git@dev --break-system-packages && \
              mkdir -p $OUTPUT_PATH && \
              xvfb-run python3 /workdir/download_and_convert.py --title '${{ github.event.inputs.title }}' --output $OUTPUT_PATH --userid '${{ secrets.ZLIBRARY_USERID }}' --userkey '${{ secrets.ZLIBRARY_USERKEY }}' && \
              echo 'Download complete, listing files:' && \
              ls -la $OUTPUT_PATH"
              
    - name: Debug output path
      run: |
              echo "OUTPUT_PATH is: ${{ env.OUTPUT_PATH }}"
              ls -la ${{ env.OUTPUT_PATH }}           
    # äº§ç‰©ä¸Šä¼ ä¼˜åŒ–
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ebook-${{ github.event.inputs.title }}
        path: "${{ env.OUTPUT_PATH }}/*"   

    # æ–°å¢ï¼šå¾®ä¿¡é€šçŸ¥æ¨¡å—
    - name: Send WeChat notification
      env:
        WXPUSHER_SPT: ${{ secrets.WXPUSHER_SPT }}
      run: |
            DOWNLOAD_URL="https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            python3 push.py \
            "ã€ç”µå­ä¹¦ä¸‹è½½å®Œæˆã€‘${{ github.event.inputs.title }}.epub å·²å°±ç»ª\nğŸ”—ä¸‹è½½åœ°å€ï¼š$DOWNLOAD_URL\nğŸ“–æ‰“å¼€æ–¹å¼ï¼šå¾®ä¿¡â†’æ–‡ä»¶â†’å…¶ä»–åº”ç”¨æ‰“å¼€â†’é€‰æ‹©é˜…è¯»å™¨" ${{ secrets.PUSH_METHOD }}


